name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
      
    - name: Build Docker image
      run: |
        docker build \
          --build-arg USER_UID=1000 \
          --build-arg USER_GID=1000 \
          -t microclimatefoam:test \
          .
      
    - name: Run test suite
      run: |
        docker run --rm \
          -v "$PWD:/workspace" \
          -w /workspace \
          --user root \
          microclimatefoam:test \
          bash -c "chown -R openfoam:openfoam /workspace && su openfoam -c 'cd /workspace && bash test_env.sh'"

